# ANPR-System-v0.3

Десктопное приложение для детекции и распознавания автомобильных номеров с локальной базой событий и настраиваемыми каналами.

## Установка

```bash
pip install -r requirements.txt
```

> Для CPU-окружения PyTorch можно установить через официальный индекс: `pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cpu`.

## Быстрый старт

```bash
python app.py
```

- Вкладка **«Монитор»** — выбор сетки (1×1, 1×2, 2×2, 2×3, 3×3), просмотр каналов и последнее событие.
- Вкладка **«События»** — таблица последних распознаваний с фильтрами по дате, каналу и списку номеров.
- Вкладка **«Поиск»** — поиск по номеру и интервалу времени.
- Вкладка **«Настройки»** — управление каналами (локальные камеры или RTSP/файлы) с группировкой по блокам «Канал», «Распознавание», «Детектор движения» и «Зона распознавания»; настройка сетки, пути к локальной базе (`settings.json`), числа бестшотов для консенсусного распознавания, паузы подавления повторов и параметров движения (частота анализа, минимальное число кадров для включения/выключения распознавания, порог движения).

## Алгоритмы и архитектура

### Слои приложения
- **UI-слой** (`anpr/ui/main_window.py`) управляет вкладками, пользовательскими действиями и жизненным циклом потоков.
- **Асинхронные фоновые работники** (`anpr/workers/channel_worker.py`) запускают `asyncio`-цикл внутри `QThread`: чтение кадра, трекинг,  OCR и запись в БД выполняются через `asyncio.to_thread`, поэтому обработка нескольких каналов не блокирует друг друга и UI.
- **Детекторы и OCR** теперь изолированы: `anpr/detection/yolo_detector.py` отвечает только за детекцию/трекинг номеров, `anpr/recognition/crnn_recognizer.py` — за OCR, `anpr/pipeline/anpr_pipeline.py` агрегирует результаты. `anpr/pipeline/factory.py` собирает компоненты без привязки к UI, а конфигурация путей вынесена в `anpr/config.py`.
- **Сервисные компоненты** (`detector.py`, `storage.py`, `settings_manager.py`, `logging_manager.py`) предоставляют независимые обязанности по принципам SOLID/DRY/KISS.

### Детекция и трекинг
- **YOLOv8** используется для поиска номерных знаков на кадре. Порог уверенности настраивается в `ModelConfig.DETECTION_CONFIDENCE_THRESHOLD` (`anpr/config.py`).
- Для видео применяется метод `track(...)` с включённым `persist=True`, что позволяет привязывать обнаружения к ID трека. При любой ошибке или отсутствии зависимостей трекера происходит **автоматический откат к чистой детекции**, чтобы не ломать поток на нескольких каналах.
- Чтобы избежать просадки FPS при срабатывании детектора движения, в настройках канала можно задать **шаг инференса детектора** (каждый N-й кадр) — YOLO запускается реже, продолжая использовать трекинг, что разгружает CPU/GPU.

### Детекция движения и запуск пайплайна
- Каждый канал имеет режим **«Обнаружение ТС: Постоянное / Детектор движения»**. В режиме детектора движение ищется только внутри настроенной ROI.
- Обработка кадров стала адаптивной: можно считать движение только на каждом N-м кадре, задавать минимальное число кадров с движением для запуска распознавания и минимальное число кадров без движения для его остановки.
- Порог чувствительности к площади изменения ROI настраивается через меню «Настройки → Детектор движения».
- Архитектура: `Кадр -> детектор движения -> (движение?) -> YOLO -> CRNN`. При отсутствии движения переход к детекции номеров не выполняется, что снижает нагрузку на CPU/GPU для многоканального ввода.

### OCR
- **CRNN** (INT8, квантизованный через `torch.ao.quantization.quantize_fx`) считывает символы с кропа номерной пластины и возвращает **уверенность OCR** (0..1) для декодированного текста.
- Перед распознаванием выполняется препроцессинг: перевод в градации серого, подавление шума, бинаризация и попытка **коррекции перспективы** по четырём углам контура, что повышает читабельность наклонённых номеров.
- Результаты ниже порога `tracking.ocr_min_confidence` автоматически помечаются как «нечитаемо» и не попадают в события, снижая шанс ложных срабатываний.

### Агрегация по треку (Track-based Recognition Aggregation)
- Для каждого ID трека собирается буфер из N «бестшотов» (`tracking.best_shots`).
- По накопленным результатам запускается **голосование**: вариант, встречающийся чаще всего и собравший кворум, принимается как консенсусный и фиксируется только один раз per track.
- Это снижает шум и убирает дубли, так как единичные ошибки OCR не проходят в итоговый поток событий.

### Подавление повторов (Cooldown)
- После фиксации номера включается таймер подавления (`tracking.cooldown_seconds`), в течение которого тот же текст не будет эмитироваться повторно даже при новых появлениях в кадре.
- Кулдаун применяется после агрегации, поэтому не мешает набору бестшотов, но предотвращает «заливку» базы одинаковыми событиями.

### Хранилище и события
- События сохраняются в локальную SQLite-базу `data/events.db` через модуль `storage.py` (паттерн Repository). Таблица хранит номер, канал, путь к кадру (при необходимости) и **UTC-время** события.
- Фоновая обработка использует **асинхронный клиент** `AsyncEventDatabase` на базе `aiosqlite`, чтобы не задерживать видеопоток при записи.
- Главный GUI поток получает новые события из каналов, обновляет виджет «Последнее событие» и таблицу «События» (100 последних). Фильтры и поиск работают напрямую с БД.

### Настройки и расширяемость
- Все параметры (пути к моделям/БД, каналы, сетка, `tracking.best_shots`, `tracking.cooldown_seconds`, `tracking.ocr_min_confidence`, частота инференса детектора) лежат в `settings.json` и управляются через `settings_manager.py`.
- Параметры каналов независимы: источник (RTSP/файл), имя, ROI распознавания, режим детекции движения, консенсус по бестшотам и пороги распознавания задаются отдельно для каждой камеры.
- Приложение разделено на независимые компоненты (детектор, OCR, пайплайн агрегации, GUI-слой, хранилище), что упрощает поддержку и соответствует принципам **SOLID/DRY/KISS и ООП**: отдельные классы отвечают за загрузку моделей, агрегацию, работу потоков и доступ к данным.

### Логирование
- `LoggingManager` настраивает единый стек логов (консоль + файл) с ротацией через `RotatingFileHandler`.
- Параметры (`logging.level`, `logging.file`, `logging.max_bytes`, `logging.backup_count`) задаются в `settings.json`.
- Ключевые события пайплайна (запуск каналов, ошибки трекера, сохранение распознанных номеров) фиксируются именованными логгерами.

## Файлы

- `settings.json` — хранит конфигурацию каналов, сетки, параметр `tracking.best_shots` для агрегации по трекам, `tracking.cooldown_seconds` для подавления повторных срабатываний и `tracking.ocr_min_confidence` для отсечения сомнительных OCR-результатов.
- `logging` — блок настроек журнала (`level`, `file`, ротация `max_bytes`/`backup_count`) для единого логирования GUI, пайплайна и фоновых потоков.
- `data/events.db` — создаётся автоматически, хранит последние 100+ событий распознавания.
- `detector.py` — CLI-обертка, использующая `anpr/detection/yolo_detector.py`, `anpr/recognition/crnn_recognizer.py` и `anpr/pipeline/anpr_pipeline.py`.
- `anpr/detection/yolo_detector.py` — детектор и трекер номерных знаков.
- `anpr/recognition/crnn_recognizer.py` — загрузка и инференс CRNN.
- `anpr/pipeline/anpr_pipeline.py` — пайплайн OCR, агрегация по трекам и отрисовка для CLI.
- `app.py` — точка входа, инициализация настроек/логирования и запуск GUI.
- `anpr/ui/main_window.py` — оконный интерфейс PyQt5 с вкладками мониторинга, событий, поиска и настроек.
- `anpr/workers/channel_worker.py` — фоновый поток, отвечающий за захват кадров и запуск ANPR-пайплайна.
- `anpr/detection/motion_detector.py` — независимый модуль детекции движения с настройкой частоты анализа и гистерезиса по кадрам.
- `anpr/pipeline/factory.py` — сборка детектора номеров, OCR и пайплайна распознавания без прямой зависимости от UI.
